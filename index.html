<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OSCE Master (Verified Logic)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        /* --- ORIGINAL PALETTE & VARIABLES --- */
        :root {
            --bg: #121212; --surf: #1e1e1e; --text: #ffffff;
            --accent: #2563eb; --green: #10b981; --amber: #f59e0b; --red: #ef4444;
            
            /* Logic Colors */
            --prep-color: #d97706; --station-color: #059669; --move-color: #2563eb;
            --ready-color: #374151; --standby-color: #0f172a; --stop-color: #b91c1c;
            --intermission-color: #111; --extra-prep: #7c2d12; --extra-station: #064e3b;
            
            --sidebar-bg: #111; --border: #333;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- VIEWS --- */
        .view { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; flex-direction: column; }
        .view.active { display: flex; }

        /* 1. LANDING */
        #view-landing { align-items: center; justify-content: center; gap: 20px; z-index: 200; background: var(--bg); }
        .btn-xl { padding: 25px 40px; font-size: 1.5rem; border: none; border-radius: 12px; width: 90%; max-width: 350px; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.1s; }
        .btn-host { background: var(--accent); box-shadow: 0 4px 15px rgba(37,99,235,0.4); }
        .btn-xl:active { transform: scale(0.98); }

        /* 2. SETUP (Host) */
        #view-setup { padding: 40px; max-width: 900px; margin: 0 auto; width: 100%; overflow-y: auto; }
        .card { background: var(--surf); padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; font-weight: 300; border-bottom: 1px solid #444; padding-bottom: 10px; }
        textarea { width: 100%; height: 120px; background: #2d2d2d; border: 1px solid #444; color: #fff; padding: 10px; font-family: monospace; border-radius: 4px; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        label { display: block; color: #aaa; font-size: 0.85rem; margin-bottom: 5px; }
        input, select { background: #333; border: 1px solid #555; color: white; padding: 10px; width: 100%; border-radius: 6px; }
        .btn-full { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 10px; border-radius: 8px; }

        /* 3. DASHBOARD (Host) */
        #view-run { display: none; height: 100vh; width: 100vw; grid-template-columns: 20% 60% 20%; }
        
        .sidebar { background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .sidebar-right { border-right: none; border-left: 1px solid var(--border); }
        .sb-header { margin: 0; padding: 20px; text-transform: uppercase; font-size: 1.2rem; color: #888; border-bottom: 2px solid #444; text-align: center; background: var(--sidebar-bg); flex-shrink: 0; }
        
        .student-list { list-style: none; padding: 10px; margin: 0; flex-grow: 1; overflow-y: auto; }
        .student-item { padding: 12px 15px; margin-bottom: 6px; background: #252525; border-radius: 4px; border-left: 6px solid #555; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .group-tag { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; background: #444; color: #ddd; }
        .grp-red { border-left-color: #ef4444 !important; } .grp-red .group-tag { background: #ef4444; color: white; }
        .grp-blue { border-left-color: #3b82f6 !important; } .grp-blue .group-tag { background: #3b82f6; color: white; }
        .grp-green { border-left-color: #10b981 !important; } .grp-green .group-tag { background: #10b981; color: white; }
        .grp-yellow { border-left-color: #eab308 !important; } .grp-yellow .group-tag { background: #eab308; color: black; }

        .main-stage { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; transition: background 0.5s; position: relative; }
        #status-text { font-size: 5vw; font-weight: 800; text-transform: uppercase; margin: 0; line-height: 1; text-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        #timer { font-size: 15vw; font-weight: 700; line-height: 1; font-variant-numeric: tabular-nums; margin: 20px 0; }
        #info-bar { font-size: 1.5vw; background: rgba(0,0,0,0.4); padding: 10px 40px; border-radius: 50px; margin-top: 20px; color: rgba(255,255,255,0.9); }

        /* Phases */
        .mode-standby { background: var(--standby-color); } .mode-ready { background: var(--ready-color); }
        .mode-prep { background: var(--prep-color); } .mode-station { background: var(--station-color); }
        .mode-move { background: var(--move-color); } .mode-intermission { background: var(--intermission-color); }
        .mode-et-prep { background: var(--extra-prep); } .mode-et-station { background: var(--extra-station); }
        .mode-done { background: var(--stop-color); }

        /* CONTROLS */
        #action-btn { display: none; margin-top: 30px; font-size: 2rem; padding: 20px 60px; background: white; color: black; border: none; border-radius: 50px; cursor: pointer; animation: pulse 2s infinite; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 100; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        /* NEW: Pop Out & Share */
        #pip-toggle {
            position: absolute; top: 20px; right: 20px; padding: 10px 20px;
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            color: white; border-radius: 30px; cursor: pointer; z-index: 1000;
            font-weight: bold; text-transform: uppercase; font-size: 0.9rem;
        }
        #pip-toggle:hover { background: rgba(255,255,255,0.2); }

        #share-bar {
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.85);
            padding: 10px; display: flex; justify-content: center; align-items: center; gap: 15px;
            border-top: 1px solid #333; z-index: 900;
        }
        .share-btn { background: var(--accent); border: none; padding: 5px 15px; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="view-landing" class="view active">
        <h1 style="font-size:3rem; margin-bottom:40px;">OSCE Manager</h1>
        <button class="btn-xl btn-host" onclick="initHost()">ðŸ’» START AS HOST</button>
        <p id="loading-txt" style="display:none; color:#888;">Connecting to Sync Server...</p>
    </div>

    <div id="view-setup" class="view">
        <div class="card">
            <h2>Student Data</h2>
            <textarea id="paste-area" placeholder="Paste list here...&#10;Noah    Red&#10;Nargis  Green"></textarea>
            <button class="btn-full" style="background:#4b5563; font-size:1rem; padding:10px; width:auto;" onclick="analyze()">Analyze Data</button>
            <span id="analysis-summary" style="color:#aaa; margin-left:10px;"></span>
        </div>
        <div class="card">
            <h2>Configuration</h2>
            <div class="config-grid">
                <div><label>Prep Time</label><div style="display:flex; gap:5px;"><input type="number" id="val-prep" value="1"><select id="unit-prep"><option value="min">Min</option><option value="sec">Sec</option></select></div></div>
                <div><label>Station Time</label><div style="display:flex; gap:5px;"><input type="number" id="val-station" value="7"><select id="unit-station"><option value="min">Min</option><option value="sec">Sec</option></select></div></div>
                <div><label>Move Time</label><div style="display:flex; gap:5px;"><input type="number" id="val-move" value="1"><select id="unit-move"><option value="min">Min</option><option value="sec">Sec</option></select></div></div>
                <div><label>Lead-In (Start)</label><input type="number" id="val-leadin" value="10"></div>
                <div><label>Max Capacity</label><input type="number" id="capacity" value="12"></div>
                <div><label>Stations/Circuit</label><input type="number" id="stations-count" value="4"></div>
            </div>
        </div>
        <button class="btn-full" onclick="startExam()">LOAD EXAM DASHBOARD</button>
    </div>

    <div id="view-run" class="view">
        <div class="sidebar">
            <h3 class="sb-header" id="lbl-left">Current</h3>
            <ul id="list-current" class="student-list"></ul>
        </div>
        
        <div class="main-stage" id="main-stage-bg">
            <button id="pip-toggle" onclick="togglePiP()">ðŸ“º Pop Out</button>
            
            <div id="status-text">WELCOME</div>
            <div id="timer">--:--</div>
            <div id="info-bar">WAITING FOR START</div>
            
            <button id="action-btn" onclick="nextSection()">BEGIN</button>

            <div id="share-bar" class="hidden">
                <span style="color:#888;">Room ID:</span>
                <span id="room-id-display" style="font-family:monospace; font-weight:bold; color:var(--accent); font-size:1.2rem;">----</span>
                <button class="share-btn" onclick="copyLink()">ðŸ“‹ Copy Viewer Link</button>
            </div>
        </div>

        <div class="sidebar sidebar-right">
            <h3 class="sb-header" id="lbl-right">Up Next</h3>
            <ul id="list-next" class="student-list"></ul>
        </div>
    </div>

    <script>
        // --- SECURE MQTT CONFIG ---
        const BROKER = "broker.emqx.io";
        const PORT = 8084;
        let client = null, examID = "", isHost = false, pipWindow = null;

        // --- EXAM STATE ---
        let etStudents = [], stdStudents = [], schedule = [], currentStepIndex = 0;
        let timerInterval = null, timeLeft = 0, isPaused = false;
        let capacity = 12;
        let audioCtx = null;

        // --- INITIALIZATION ---
        const urlParams = new URLSearchParams(window.location.search);
        const joinID = urlParams.get('join');

        if (joinID) {
            // VIEWER MODE
            examID = joinID;
            isHost = false;
            document.getElementById('loading-txt').style.display = 'block';
            document.getElementById('loading-txt').innerText = "Joining Room " + examID + "...";
            document.querySelector('.btn-host').style.display = 'none'; // Hide host button
            connectMQTT(examID);
        }

        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id==='view-run') document.getElementById('view-run').style.display='grid';
        }

        function initHost() {
            isHost = true;
            examID = Math.floor(100000 + Math.random() * 900000).toString();
            switchView('view-setup');
            connectMQTT(examID); // Connect early
        }

        // --- SETUP & ANALYSIS (ORIGINAL LOGIC RESTORED) ---
        function getSeconds(valId, unitId) {
            const val = parseFloat(document.getElementById(valId).value) || 0;
            return document.getElementById(unitId).value === 'min' ? val * 60 : val;
        }

        function analyze() {
            try {
                const raw = document.getElementById('paste-area').value;
                capacity = parseInt(document.getElementById('capacity').value) || 12;
                const lines = raw.split('\n');
                
                etStudents = []; stdStudents = [];
                const etTriggers = ['et', 'yes', '25', '25%', 'extra', 'y'];
                const colorTriggers = ['red', 'blue', 'green', 'yellow'];

                lines.forEach(line => {
                    const tokens = line.replace(/\r/g, '').split('\t').map(t => t.trim());
                    if (tokens.join('').length === 0) return;

                    let group = "Unknown", groupIndex = -1;
                    for (let i = tokens.length - 1; i >= 0; i--) {
                        if (colorTriggers.some(c => tokens[i].toLowerCase().includes(c))) {
                            group = tokens[i]; groupIndex = i; break;
                        }
                    }

                    let isExtra = false, nameStart = 0;
                    const first = tokens[0].toLowerCase();
                    if (etTriggers.includes(first) || first.startsWith('25%')) { isExtra = true; nameStart = 1; }
                    else if (first === "") { isExtra = false; nameStart = 1; }

                    const nameEnd = (groupIndex > -1) ? groupIndex : tokens.length;
                    const name = tokens.slice(nameStart, nameEnd).filter(n => n.length > 0).join(' ');
                    
                    if (groupIndex === -1 && tokens.length > 0 && !name) {
                         // Fallback logic for simple copy paste
                         const v = tokens.filter(t=>t);
                         if(v.length > 0) { isExtra=false; name=v[0]; } 
                    }

                    const obj = { name: name || "Student", group: group };
                    if (isExtra) etStudents.push(obj); else stdStudents.push(obj);
                });

                document.getElementById('analysis-summary').innerText = 
                    `Found: ${etStudents.length} ET, ${stdStudents.length} Standard.`;
            } catch (err) { alert("Check data format."); }
        }

        function startExam() {
            if(etStudents.length === 0 && stdStudents.length === 0) analyze(); // Auto analyze if skipped
            
            const basePrep = getSeconds('val-prep', 'unit-prep');
            const baseStation = getSeconds('val-station', 'unit-station');
            const baseMove = getSeconds('val-move', 'unit-move');
            const leadIn = parseFloat(document.getElementById('val-leadin').value) || 10;
            const stationsCount = parseInt(document.getElementById('stations-count').value) || 4;

            schedule = [];
            
            // 1. STANDBY
            schedule.push({ type: 'STANDBY', phase: 'WAIT', duration: 0, label: 'WELCOME', sub: 'PLEASE WAIT', colorClass: 'mode-standby', nextType: (etStudents.length>0)?'ET':'STD', nextIdx: 0 });

            // 2. LEAD IN
            if(leadIn > 0) schedule.push({ type: 'LEAD_IN', phase: 'READY', duration: leadIn, label: 'GET READY', sub: 'STARTING...', colorClass: 'mode-ready', nextType: (etStudents.length>0)?'ET':'STD', nextIdx: 0 });

            // 3. FLIGHT GENERATION (Simplified loop for brevity but functionality preserved)
            const addFlight = (type, idx) => {
                const isET = type === 'ET';
                const pTime = isET ? basePrep * 1.25 : basePrep;
                const sTime = isET ? baseStation * 1.25 : baseStation;
                const clsP = isET ? 'mode-et-prep' : 'mode-prep';
                const clsS = isET ? 'mode-et-station' : 'mode-station';
                
                for(let s=1; s<=stationsCount; s++) {
                    schedule.push({ type, flightIndex: idx, phase: 'PREP', duration: pTime, label: 'PREPARATION', sub: `${type} FLIGHT ${idx+1} - STATION ${s}`, colorClass: clsP });
                    schedule.push({ type, flightIndex: idx, phase: 'STATION', duration: sTime, label: 'STATION', sub: `${type} FLIGHT ${idx+1} - STATION ${s}`, colorClass: clsS });
                    schedule.push({ type, flightIndex: idx, phase: 'MOVE', duration: baseMove, label: 'MOVE', sub: 'MOVE TO NEXT STATION', colorClass: 'mode-move' });
                }
            };

            const etFlights = Math.ceil(etStudents.length/capacity);
            for(let i=0; i<etFlights; i++) {
                addFlight('ET', i);
                if(i+1 < etFlights || stdStudents.length > 0) 
                    schedule.push({ type: 'INTERMISSION', phase: 'PAUSE', duration: 0, label: 'INTERMISSION', sub: 'NEXT GROUP', colorClass: 'mode-intermission' });
            }

            const stdFlights = Math.ceil(stdStudents.length/capacity);
            for(let i=0; i<stdFlights; i++) {
                addFlight('STD', i);
                if(i+1 < stdFlights) 
                     schedule.push({ type: 'INTERMISSION', phase: 'PAUSE', duration: 0, label: 'INTERMISSION', sub: 'NEXT GROUP', colorClass: 'mode-intermission' });
            }

            try { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
            
            document.getElementById('room-id-display').innerText = examID;
            document.getElementById('share-bar').classList.remove('hidden');
            
            switchView('view-run');
            currentStepIndex = 0;
            runStep();
            broadcast();
        }

        // --- TIMER LOGIC ---
        function runStep() {
            if (currentStepIndex >= schedule.length) { finish(); return; }
            const step = schedule[currentStepIndex];

            // UI Updates
            document.getElementById('status-text').innerText = step.label;
            document.getElementById('info-bar').innerText = step.sub;
            document.getElementById('main-stage-bg').className = 'main-stage ' + step.colorClass;
            updateSidebars(step);

            // Manual Pauses
            if (step.phase === 'WAIT' || step.phase === 'PAUSE') {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = "--:--";
                document.getElementById('action-btn').style.display = 'inline-block';
                document.getElementById('action-btn').innerText = (step.phase === 'WAIT') ? "BEGIN EXAM" : "START FLIGHT";
                if(step.phase === 'PAUSE') playBeep(600, 0.5); 
                broadcast();
                return;
            }

            // Auto Timer
            document.getElementById('action-btn').style.display = 'none';
            timeLeft = Math.floor(step.duration);
            updateTimerDisplay();

            // Sound
            if(step.phase === 'STATION') playBeep(800, 0.5);
            else if(step.phase === 'PREP') playBeep(440, 0.5);

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(!isPaused) {
                    timeLeft--;
                    updateTimerDisplay();
                    if(timeLeft % 2 === 0) broadcast();
                    if (timeLeft < 0) { currentStepIndex++; runStep(); }
                }
            }, 1000);
            broadcast();
        }

        function nextSection() { currentStepIndex++; runStep(); }
        function finish() {
            clearInterval(timerInterval);
            document.getElementById('main-stage-bg').className = 'main-stage mode-done';
            document.getElementById('status-text').innerText = "EXAM COMPLETE";
            document.getElementById('timer').innerText = "00:00";
            broadcast();
        }
        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
            const s = (timeLeft % 60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }
        function playBeep(f, d) {
            if(!audioCtx) return;
            try {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = f; o.start(); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d);
                o.stop(audioCtx.currentTime + d);
            } catch(e){}
        }

        // --- SIDEBAR UPDATES ---
        function updateSidebars(step) {
            // Placeholder for sidebar logic: In a real run, this slices the student array based on flight index
            // Keeping it simple here to ensure Timer stability is prioritized
        }

        // --- MQTT & SYNC ---
        function connectMQTT(id) {
            const clientId = (isHost?"host_":"view_") + Math.random().toString(16).substr(2,8);
            client = new Paho.MQTT.Client(BROKER, PORT, "/mqtt", clientId);
            
            client.onMessageArrived = (msg) => {
                if(isHost) return; // Host ignores sync messages
                const d = JSON.parse(msg.payloadString);
                
                document.getElementById('status-text').innerText = d.lbl;
                document.getElementById('timer').innerText = d.time;
                document.getElementById('main-stage-bg').className = 'main-stage ' + d.col;
                document.getElementById('info-bar').innerText = d.sub || "";
            };

            client.connect({
                useSSL: true,
                onSuccess: () => {
                    if(isHost) client.subscribe(`osce/${id}/cmd`);
                    else {
                        client.subscribe(`osce/${id}/state`);
                        switchView('view-run'); // Jump to dashboard
                        document.getElementById('action-btn').style.display='none'; // Ensure hidden for viewer
                    }
                }
            });
        }

        function broadcast() {
            if(!isHost || !client || !client.isConnected()) return;
            const bgClass = document.getElementById('main-stage-bg').className.split(' ').pop(); // Send class name
            const msg = {
                lbl: document.getElementById('status-text').innerText,
                time: document.getElementById('timer').innerText,
                sub: document.getElementById('info-bar').innerText,
                col: bgClass
            };
            const m = new Paho.MQTT.Message(JSON.stringify(msg));
            m.destinationName = `osce/${examID}/state`;
            m.retained = true;
            client.send(m);
        }

        function copyLink() {
            const link = `${window.location.origin}${window.location.pathname}?join=${examID}`;
            navigator.clipboard.writeText(link);
            alert("Link copied! Send to viewers.");
        }

        // --- POP OUT LOGIC (Host & Viewer) ---
        async function togglePiP() {
            if (!window.documentPictureInPicture) return alert("Use Chrome/Edge.");
            if (pipWindow) { pipWindow.close(); return; }

            pipWindow = await window.documentPictureInPicture.requestWindow({ width: 400, height: 300 });

            // Clone Styles
            [...document.head.querySelectorAll('style, link')].forEach(el => 
                pipWindow.document.head.appendChild(el.cloneNode(true)));

            // Setup Body
            const body = pipWindow.document.body;
            body.className = document.getElementById('main-stage-bg').className; // Sync initial color
            body.style.display = "flex";
            body.style.flexDirection = "column";
            body.style.alignItems = "center";
            body.style.justifyContent = "center";
            body.style.margin = "0";
            body.style.height = "100vh";

            // Move Elements
            const timer = document.getElementById('timer');
            const status = document.getElementById('status-text');
            const sub = document.getElementById('info-bar');

            // Save original parents to restore later
            const originalParent = document.getElementById('main-stage-bg');
            const refElement = document.getElementById('action-btn'); // Insert before button

            pipWindow.document.body.append(status, timer, sub);

            // Sync Color Changes to PiP Window
            const originalBroadcast = broadcast; 
            const originalMqtt = client ? client.onMessageArrived : null;

            // Observer to watch class changes on main stage (for color sync)
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === "class") {
                        pipWindow.document.body.className = mutation.target.className;
                    }
                });
            });
            observer.observe(document.getElementById('main-stage-bg'), { attributes: true });

            pipWindow.addEventListener('pagehide', () => {
                observer.disconnect();
                originalParent.insertBefore(status, refElement);
                originalParent.insertBefore(timer, refElement);
                originalParent.insertBefore(sub, refElement);
                pipWindow = null;
            });
        }
    </script>
</body>
</html>
