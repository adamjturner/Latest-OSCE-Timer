<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OSCE Master (Connection Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg: #121212; --surf: #1e1e1e; --text: #ffffff;
            --accent: #2563eb; --green: #10b981; --amber: #f59e0b; --red: #ef4444;
            --prep-color: #d97706; --station-color: #059669; --move-color: #2563eb;
            --ready-color: #374151; --standby-color: #0f172a; --stop-color: #b91c1c;
            --intermission-color: #111; --extra-prep: #7c2d12; --extra-station: #064e3b;
            --sidebar-bg: #111; --border: #333;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .view { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; flex-direction: column; }
        .view.active { display: flex; }

        /* STATUS DOT */
        #conn-status {
            position: fixed; top: 10px; left: 10px; z-index: 9999;
            background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 20px;
            font-size: 0.75rem; font-weight: bold; color: #aaa;
            display: flex; align-items: center; gap: 8px; border: 1px solid #333;
        }
        #conn-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); box-shadow: 0 0 5px var(--red); transition: background 0.3s; }
        .conn-active #conn-dot { background: var(--green) !important; box-shadow: 0 0 5px var(--green) !important; }

        /* 1. LANDING */
        #view-landing { align-items: center; justify-content: center; gap: 20px; z-index: 200; background: var(--bg); }
        .btn-xl { padding: 25px 40px; font-size: 1.5rem; border: none; border-radius: 12px; width: 90%; max-width: 350px; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.1s; }
        .btn-host { background: var(--accent); box-shadow: 0 4px 15px rgba(37,99,235,0.4); }
        .btn-remote { background: var(--green); box-shadow: 0 4px 15px rgba(16,185,129,0.4); }
        .btn-xl:active { transform: scale(0.98); }

        /* 2. SETUP */
        #view-setup { padding: 40px; max-width: 900px; margin: 0 auto; width: 100%; overflow-y: auto; padding-bottom: 80px; }
        .card { background: var(--surf); padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; font-weight: 300; border-bottom: 1px solid #444; padding-bottom: 10px; }
        textarea { width: 100%; height: 120px; background: #2d2d2d; border: 1px solid #444; color: #fff; padding: 10px; font-family: monospace; border-radius: 4px; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        label { display: block; color: #aaa; font-size: 0.85rem; margin-bottom: 5px; }
        input, select { background: #333; border: 1px solid #555; color: white; padding: 10px; width: 100%; border-radius: 6px; }
        .input-wrapper { display: flex; gap: 5px; }
        .btn-full { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 10px; border-radius: 8px; }

        /* 3. DASHBOARD */
        #view-run { display: none; height: 100vh; width: 100vw; grid-template-columns: 220px 1fr 220px; }
        .sidebar { background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .sidebar-right { border-right: none; border-left: 1px solid var(--border); }
        .sb-header { margin: 0; padding: 15px; text-transform: uppercase; font-size: 1rem; color: #888; border-bottom: 1px solid #333; text-align: center; background: #161616; flex-shrink: 0; letter-spacing: 1px; }
        
        .student-list { list-style: none; padding: 10px; margin: 0; flex-grow: 1; overflow-y: auto; }
        .student-item { padding: 10px 12px; margin-bottom: 6px; background: #252525; border-radius: 4px; border-left: 5px solid #555; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
        .group-tag { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 3px; background: #444; color: #ddd; min-width: 45px; text-align: center; }
        
        .grp-red { border-left-color: #ef4444 !important; } .grp-red .group-tag { background: #7f1d1d; color: #fecaca; }
        .grp-blue { border-left-color: #3b82f6 !important; } .grp-blue .group-tag { background: #1e3a8a; color: #bfdbfe; }
        .grp-green { border-left-color: #10b981 !important; } .grp-green .group-tag { background: #064e3b; color: #a7f3d0; }
        .grp-yellow { border-left-color: #eab308 !important; } .grp-yellow .group-tag { background: #713f12; color: #fef08a; }

        .main-stage { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; height: 100%; transition: background 0.5s; position: relative; overflow: hidden; }
        #stage-content { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        #status-text { font-size: 5vw; font-weight: 800; text-transform: uppercase; margin: 0; line-height: 1; text-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        #timer { font-size: 18vw; font-weight: 700; line-height: 0.9; font-variant-numeric: tabular-nums; margin: 10px 0; letter-spacing: -5px; }
        #info-bar { font-size: 1.5vw; background: rgba(0,0,0,0.4); padding: 8px 30px; border-radius: 50px; margin-top: 20px; color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.1); }

        #action-btn { display: none; margin-top: 30px; font-size: 1.5rem; padding: 15px 50px; background: white; color: black; border: none; border-radius: 50px; cursor: pointer; animation: pulse 2s infinite; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 100; font-weight: bold; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #top-right-tools { position: absolute; top: 20px; right: 20px; z-index: 1000; }
        .tool-btn { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; font-weight: bold; transition: background 0.2s; }
        .tool-btn:hover { background: rgba(255,255,255,0.3); }

        /* SHARE BAR */
        #host-share-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.95); padding: 15px; 
            text-align: center; border-top: 1px solid #444; 
            display: none; z-index: 9000;
            display: flex; align-items: center; justify-content: center; gap: 20px;
        }
        .share-link { color: var(--green); font-family: monospace; font-size: 1.1rem; border-bottom: 1px dashed var(--green); cursor: pointer; }

        /* 4. REMOTE */
        #view-remote-login, #view-remote { align-items: center; justify-content: center; padding: 20px; }
        #remote-code-input { font-size: 3rem; width: 200px; text-align: center; margin: 20px 0; background: #333; border: 2px solid #555; color: white; border-radius: 12px; padding: 10px; letter-spacing: 5px; }
        
        .rem-grid { display: grid; grid-template-rows: 1fr 2fr 1fr; width: 100%; height: 100%; gap: 15px; max-width: 500px; }
        .rem-status { background: #222; border-radius: 15px; border: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: background 0.3s; }
        .rem-btn { border: none; border-radius: 15px; font-size: 1.8rem; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .rem-btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-next { background: var(--accent); } .btn-pause { background: var(--amber); } .btn-exit { background: var(--red); }
    </style>
</head>
<body>

    <div id="conn-status">
        <div id="conn-dot"></div>
        <span id="conn-text">Disconnected</span>
    </div>

    <div id="view-landing" class="view active">
        <h1 style="font-size:3rem; margin-bottom:40px;">OSCE Manager</h1>
        <button class="btn-xl btn-host" onclick="initHost()">ðŸ’» START AS HOST</button>
        <button class="btn-xl btn-remote" onclick="initRemote()">ðŸ“± START AS REMOTE</button>
        <div id="viewer-msg" style="display:none; color:#aaa; margin-top:20px; font-size:1.2rem;">Connecting to Session...</div>
    </div>

    <div id="view-setup" class="view">
        <div class="card">
            <h2>Student Data</h2>
            <textarea id="paste-area" placeholder="Example:&#10;Noah    Red&#10;Nargis  Green&#10;John    Blue"></textarea>
            <button class="btn-full" style="background:#4b5563; width:auto; padding:10px 20px; font-size:1rem;" onclick="analyze()">Analyze & Group</button>
            <span id="analysis-summary" style="color:#aaa; margin-left:10px;"></span>
        </div>
        <div class="card">
            <h2>Configuration</h2>
            <div class="config-grid">
                <div><label>Prep Time</label><div class="input-wrapper"><input type="number" id="val-prep" value="1"><select id="unit-prep"><option value="min">Min</option><option value="sec">Sec</option></select></div></div>
                <div><label>Station Time</label><div class="input-wrapper"><input type="number" id="val-station" value="7"><select id="unit-station"><option value="min">Min</option><option value="sec">Sec</option></select></div></div>
                <div><label>Move Time</label><div class="input-wrapper"><input type="number" id="val-move" value="1"><select id="unit-move"><option value="min">Min</option><option value="sec">Sec</option></select></div></div>
                <div><label>Lead-In (Start)</label><input type="number" id="val-leadin" value="10"></div>
                <div><label>Max Capacity</label><input type="number" id="capacity" value="12"></div>
                <div><label>Stations/Circuit</label><input type="number" id="stations-count" value="4"></div>
            </div>
        </div>
        <button class="btn-full" onclick="startExam()">LOAD EXAM DASHBOARD</button>
    </div>

    <div id="view-run" class="view">
        <div class="sidebar">
            <h3 class="sb-header" id="lbl-left">Current</h3>
            <ul id="list-current" class="student-list"></ul>
        </div>
        
        <div class="main-stage" id="main-stage-bg">
            <div id="top-right-tools">
                <button class="tool-btn" onclick="togglePiP()">ðŸ“º Pop Out</button>
            </div>
            <div id="stage-content">
                <div id="status-text">WELCOME</div>
                <div id="timer">--:--</div>
                <div id="info-bar">WAITING FOR HOST...</div>
            </div>
            <button id="action-btn" onclick="nextSection()">BEGIN</button>
        </div>

        <div class="sidebar sidebar-right">
            <h3 class="sb-header" id="lbl-right">Up Next</h3>
            <ul id="list-next" class="student-list"></ul>
        </div>
    </div>

    <div id="host-share-bar">
        <span style="color:#aaa;">Session ID:</span>
        <span id="code-display" style="color:white; font-weight:bold; font-size:1.5rem; letter-spacing:1px;">----</span>
        <div style="width:1px; height:25px; background:#444;"></div>
        <span class="share-link" onclick="copyLink()">ðŸ“‹ Copy Viewer Link</span>
    </div>

    <div id="view-remote-login" class="view">
        <h2>ENTER EXAM CODE</h2>
        <input type="number" id="remote-code-input" placeholder="0000">
        <button class="btn-xl btn-remote" onclick="connectRemote()">CONNECT</button>
        <p id="rem-msg" style="color:var(--amber); margin-top:20px;"></p>
    </div>

    <div id="view-remote" class="view">
        <div class="rem-grid">
            <div class="rem-status" id="rem-bg">
                <div id="rem-lbl" style="font-size:1.5rem; font-weight:bold;">READY</div>
                <div id="rem-time" style="font-size:4rem; font-family:monospace; font-weight:bold;">--:--</div>
                <div id="rem-sub" style="color:#aaa;">Waiting...</div>
            </div>
            <button class="rem-btn btn-next" onclick="sendCmd('CLICK')">NEXT / START</button>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <button class="rem-btn btn-pause" onclick="sendCmd('PAUSE')">PAUSE</button>
                <button class="rem-btn btn-exit" onclick="location.reload()">EXIT</button>
            </div>
        </div>
    </div>

    <script>
        const BROKER = "broker.emqx.io";
        const PORT = 8084;
        let client = null, examID = "", isHost = false, pipWindow = null;
        let targetTime = null, isPaused = false, pauseTimeLeft = 0;
        let etStudents = [], stdStudents = [], schedule = [], currentStepIndex = 0;
        let capacity = 12; let audioCtx = null;
        let elStatus, elTimer, elInfo, elStageBg, elActionBtn;

        window.onload = () => {
            elStatus = document.getElementById('status-text');
            elTimer = document.getElementById('timer');
            elInfo = document.getElementById('info-bar');
            elStageBg = document.getElementById('main-stage-bg');
            elActionBtn = document.getElementById('action-btn');

            const params = new URLSearchParams(window.location.search);
            const joinID = params.get('join');
            if(joinID) {
                isHost = false;
                examID = joinID;
                document.getElementById('viewer-msg').style.display = 'block';
                document.querySelector('.btn-host').style.display = 'none';
                document.querySelector('.btn-remote').style.display = 'none';
                connectMQTT(joinID);
            }
        };

        function setStatus(connected, msg) {
            const ind = document.getElementById('conn-status');
            const txt = document.getElementById('conn-text');
            if(connected) { ind.classList.add('conn-active'); txt.innerText = "Online"; txt.style.color = "var(--green)"; }
            else { ind.classList.remove('conn-active'); txt.innerText = msg||"Offline"; txt.style.color = "var(--red)"; }
        }

        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id==='view-run') document.getElementById('view-run').style.display='grid';
        }

        function initHost() { isHost = true; examID = Math.floor(100000 + Math.random() * 900000).toString(); switchView('view-setup'); document.getElementById('host-share-bar').style.display = 'flex'; document.getElementById('code-display').innerText = examID; connectMQTT(examID); }
        function initRemote() { isHost = false; switchView('view-remote-login'); }
        function connectRemote() { examID = document.getElementById('remote-code-input').value; connectMQTT(examID); }
        function getSeconds(valId, unitId) { const val = parseFloat(document.getElementById(valId).value)||0; return document.getElementById(unitId).value==='min'?val*60:val; }

        function analyze() {
            const raw = document.getElementById('paste-area').value;
            capacity = parseInt(document.getElementById('capacity').value) || 12;
            const lines = raw.split('\n');
            etStudents = []; stdStudents = [];
            const etTriggers = ['et', 'yes', '25', '25%', 'extra', 'y'];
            const colorTriggers = ['red', 'blue', 'green', 'yellow'];
            lines.forEach(line => {
                const tokens = line.replace(/\r/g, '').split('\t').map(t => t.trim());
                if (tokens.join('').length === 0) return;
                let group = "Unknown", groupIndex = -1;
                for (let i = tokens.length - 1; i >= 0; i--) { if (colorTriggers.some(c => tokens[i].toLowerCase().includes(c))) { group = tokens[i]; groupIndex = i; break; } }
                let isExtra = false, nameStart = 0;
                const first = tokens[0].toLowerCase();
                if (etTriggers.includes(first) || first.startsWith('25%')) { isExtra = true; nameStart = 1; }
                else if (first === "") { isExtra = false; nameStart = 1; }
                const nameEnd = (groupIndex > -1) ? groupIndex : tokens.length;
                const name = tokens.slice(nameStart, nameEnd).filter(n => n).join(' ');
                const obj = { name: name || "Student", group: group };
                if (isExtra) etStudents.push(obj); else stdStudents.push(obj);
            });
            const etF = Math.ceil(etStudents.length/capacity); const stdF = Math.ceil(stdStudents.length/capacity);
            document.getElementById('analysis-summary').innerText = `Found: ${etStudents.length} ET (${etF} flights), ${stdStudents.length} STD (${stdF} flights)`;
        }

        function startExam() {
            if(etStudents.length===0 && stdStudents.length===0) analyze();
            const basePrep = getSeconds('val-prep', 'unit-prep');
            const baseStation = getSeconds('val-station', 'unit-station');
            const baseMove = getSeconds('val-move', 'unit-move');
            const leadIn = parseFloat(document.getElementById('val-leadin').value) || 10;
            const stationsCount = parseInt(document.getElementById('stations-count').value) || 4;
            schedule = [];
            schedule.push({ type:'STANDBY', phase:'WAIT', duration:0, label:'WELCOME', sub:'PLEASE WAIT', colorClass:'mode-standby', nextType:(etStudents.length>0)?'ET':'STD', nextIdx:0 });
            if(leadIn > 0) schedule.push({ type:'LEAD_IN', phase:'READY', duration:leadIn, label:'GET READY', sub:'STARTING...', colorClass:'mode-ready', nextType:(etStudents.length>0)?'ET':'STD', nextIdx:0 });
            const createFlight = (type, idx) => {
                const isET = type === 'ET';
                const p = isET ? basePrep * 1.25 : basePrep; const s = isET ? baseStation * 1.25 : baseStation;
                const cP = isET ? 'mode-et-prep' : 'mode-prep'; const cS = isET ? 'mode-et-station' : 'mode-station';
                for(let i=1; i<=stationsCount; i++) {
                    schedule.push({ type, phase:'PREP', duration:p, label:'PREPARATION', sub:`${type} FLIGHT ${idx+1} - STATION ${i}`, colorClass:cP, flightIndex:idx });
                    schedule.push({ type, phase:'STATION', duration:s, label:'STATION', sub:`${type} FLIGHT ${idx+1} - STATION ${i}`, colorClass:cS, flightIndex:idx });
                    schedule.push({ type, phase:'MOVE', duration:baseMove, label:'MOVE', sub:'ROTATE', colorClass:'mode-move', flightIndex:idx });
                }
            };
            const etCount = Math.ceil(etStudents.length/capacity);
            for(let i=0; i<etCount; i++) {
                createFlight('ET', i);
                if(i+1<etCount || stdStudents.length>0) schedule.push({ type:'INTERMISSION', phase:'PAUSE', duration:0, label:'INTERMISSION', sub:'NEXT GROUP', colorClass:'mode-intermission', nextType:(i+1<etCount)?'ET':'STD', nextIdx:(i+1<etCount)?i+1:0 });
            }
            const stdCount = Math.ceil(stdStudents.length/capacity);
            for(let i=0; i<stdCount; i++) {
                createFlight('STD', i);
                if(i+1<stdCount) schedule.push({ type:'INTERMISSION', phase:'PAUSE', duration:0, label:'INTERMISSION', sub:'NEXT GROUP', colorClass:'mode-intermission', nextType:'STD', nextIdx:i+1 });
            }
            switchView('view-run'); currentStepIndex = 0; runStep();
        }

        function runStep() {
            if (currentStepIndex >= schedule.length) { finish(); return; }
            const step = schedule[currentStepIndex];
            elStatus.innerText = step.label; elInfo.innerText = step.sub;
            elStageBg.className = 'main-stage ' + step.colorClass;
            if(pipWindow) pipWindow.document.body.className = 'main-stage ' + step.colorClass;
            updateSidebars(step);
            if(step.phase === 'WAIT' || step.phase === 'PAUSE') {
                targetTime = null; elTimer.innerText = "--:--";
                elActionBtn.style.display = 'inline-block'; elActionBtn.innerText = (step.phase === 'WAIT') ? "BEGIN EXAM" : "START FLIGHT";
                if(step.phase === 'PAUSE') playBeep(600, 0.5);
                broadcastState(); return;
            }
            elActionBtn.style.display = 'none'; targetTime = Date.now() + (step.duration * 1000); isPaused = false;
            if(step.phase === 'STATION') playBeep(800, 0.5); else if(step.phase === 'PREP') playBeep(440, 0.5);
            broadcastState();
        }
        function nextSection() { currentStepIndex++; runStep(); }
        function togglePause() { isPaused = !isPaused; if(isPaused) { pauseTimeLeft = targetTime - Date.now(); targetTime = null; } else { targetTime = Date.now() + pauseTimeLeft; } broadcastState(); }
        
        setInterval(() => {
            if (targetTime) {
                const diff = targetTime - Date.now();
                if (diff <= 0) {
                    elTimer.innerText = "00:00";
                    if (isHost && currentStepIndex < schedule.length) { targetTime = null; nextSection(); }
                } else {
                    const m = Math.floor(diff / 60000).toString().padStart(2, '0'); const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                    elTimer.innerText = `${m}:${s}`;
                }
            } else {
                 if(isPaused && pauseTimeLeft > 0) {
                    const m = Math.floor(pauseTimeLeft / 60000).toString().padStart(2, '0'); const s = Math.floor((pauseTimeLeft % 60000) / 1000).toString().padStart(2, '0');
                    elTimer.innerText = `${m}:${s}`;
                 }
            }
        }, 100);
        function finish() { targetTime = null; elStatus.innerText = "DONE"; elTimer.innerText = "00:00"; elStageBg.className = 'main-stage mode-done'; if(pipWindow) pipWindow.document.body.className = 'main-stage mode-done'; broadcastState(); }

        function updateSidebars(step) {
            let cur = [], nxt = [];
            const getSlice = (arr, i) => arr.slice(i*capacity, (i*capacity)+capacity);
            if (step.type === 'STANDBY' || step.type === 'LEAD_IN' || step.type === 'INTERMISSION') {
                document.getElementById('lbl-left').innerText = "Get Ready";
                const type = step.nextType; const idx = step.nextIdx;
                cur = (type === 'ET') ? getSlice(etStudents, idx) : getSlice(stdStudents, idx);
                const etF = Math.ceil(etStudents.length/capacity); const stdF = Math.ceil(stdStudents.length/capacity);
                if(type === 'ET') { nxt = (idx+1 < etF) ? getSlice(etStudents, idx+1) : (stdStudents.length > 0 ? getSlice(stdStudents, 0) : []); }
                else { nxt = (idx+1 < stdF) ? getSlice(stdStudents, idx+1) : []; }
            } else {
                document.getElementById('lbl-left').innerText = "Current";
                cur = (step.type === 'ET') ? getSlice(etStudents, step.flightIndex) : getSlice(stdStudents, step.flightIndex);
                nxt = [];
            }
            renderStudentList('list-current', cur); renderStudentList('list-next', nxt);
        }
        function renderStudentList(id, list) {
            const ul = document.getElementById(id); ul.innerHTML = '';
            if(!list || list.length===0) { ul.innerHTML = '<li style="padding:15px; color:#555; text-align:center;">-</li>'; return; }
            const sorted = [...list].sort((a, b) => (a.group || "").localeCompare(b.group || ""));
            sorted.forEach(s => {
                const li = document.createElement('li');
                let c = ""; const g = (s.group||"").toLowerCase();
                if(g.includes('red')) c='grp-red'; else if(g.includes('blue')) c='grp-blue'; else if(g.includes('green')) c='grp-green'; else if(g.includes('yellow')) c='grp-yellow';
                li.className = `student-item ${c}`; li.innerHTML = `<span>${s.name}</span><span class="group-tag">${s.group}</span>`; ul.appendChild(li);
            });
        }

        function connectMQTT(id) {
            setStatus(false, "Connecting...");
            const clientId = (isHost?"host_":"conn_") + Math.random().toString(16).substr(2,8);
            client = new Paho.MQTT.Client(BROKER, PORT, "/mqtt", clientId);
            client.onConnectionLost = (o) => { setStatus(false, "Lost Connection"); console.log(o); };
            client.onMessageArrived = (msg) => {
                const d = JSON.parse(msg.payloadString);
                if(isHost) {
                    if(d.act === 'CLICK' && elActionBtn.style.display !== 'none') nextSection();
                    if(d.act === 'PAUSE') togglePause();
                    return;
                }
                targetTime = d.target; isPaused = d.paused; pauseTimeLeft = d.ptl;
                if(document.getElementById('view-remote').classList.contains('active')) {
                    document.getElementById('rem-lbl').innerText = d.lbl; document.getElementById('rem-sub').innerText = d.sub;
                    document.getElementById('rem-bg').style.background = getComputedStyle(document.body).getPropertyValue('--'+d.col.replace('main-stage mode-','')+'-color');
                } else {
                    elStatus.innerText = d.lbl; elInfo.innerText = d.sub;
                    const colClass = 'main-stage ' + d.col; elStageBg.className = colClass;
                    if(pipWindow) pipWindow.document.body.className = colClass;
                }
            };
            client.connect({
                useSSL: true,
                onSuccess: () => {
                    setStatus(true, "Online");
                    if(isHost) { client.subscribe(`osce/${id}/cmd`); } 
                    else { 
                        client.subscribe(`osce/${id}/state`);
                        // KEY FIX: Move Viewers to Run View Immediately
                        const isLogin = document.getElementById('view-remote-login').classList.contains('active');
                        if(isLogin) switchView('view-remote');
                        else if(!isHost && document.getElementById('view-landing').classList.contains('active')) switchView('view-run');
                    }
                },
                onFailure: () => { setStatus(false, "Blocked/Failed"); alert("Network Blocked."); }
            });
        }
        function broadcastState() {
            if(!isHost || !client || !client.isConnected()) return;
            const msg = { target: targetTime, paused: isPaused, ptl: pauseTimeLeft, lbl: elStatus.innerText, sub: elInfo.innerText, col: elStageBg.className.split(' ').pop() };
            const m = new Paho.MQTT.Message(JSON.stringify(msg)); m.destinationName = `osce/${examID}/state`; m.retained = true; client.send(m);
        }
        function sendCmd(act) { if(!client || !client.isConnected()) return; const m = new Paho.MQTT.Message(JSON.stringify({ act })); m.destinationName = `osce/${examID}/cmd`; client.send(m); }
        function copyLink() { const link = `${window.location.origin}${window.location.pathname}?join=${examID}`; navigator.clipboard.writeText(link); alert("Viewer Link Copied!"); }
        function playBeep(f,d) { if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); try{const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=f;o.start();g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d);}catch(e){} }
        async function togglePiP() {
            if (!window.documentPictureInPicture) return alert("Use Chrome/Edge.");
            if (pipWindow) { pipWindow.close(); return; }
            pipWindow = await window.documentPictureInPicture.requestWindow({ width: 500, height: 350 });
            [...document.head.querySelectorAll('style, link')].forEach(el => pipWindow.document.head.appendChild(el.cloneNode(true)));
            const body = pipWindow.document.body; body.className = elStageBg.className; body.style.display="flex"; body.style.alignItems="center"; body.style.justifyContent="center"; body.style.height="100vh";
            const content = document.getElementById('stage-content'); body.append(content);
            pipWindow.addEventListener('pagehide', () => { elStageBg.insertBefore(content, elActionBtn); pipWindow = null; });
        }
    </script>
</body>
</html>
